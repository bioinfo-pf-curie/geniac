# TODO: some of those parameters should be changed through the CLI
# NB: This file rely on python configparser extended interpolation which is using ${section:option}
# to denote a value from a foreign section.every pattern in this file. If any value in a section
# contain the $ character, it should be expanded twice (e.g. end of
# geniac.install.cmakeOutputPattern)
###############################################################################
#           Project section describe metadata related to CLI tools            #
###############################################################################

# TODO: should also accept directories for DSL2
# Paths to workflow scripts
[project.workflow]
main         = ${tree.base:path}/**/*.nf

# Metadata used with installation commands
[project.metadata]
branch

###############################################################################
#                       Geniac lint options                                   #
###############################################################################

# Mandatory [tree.*] sections expected for geniac
[geniac.lint.directories]
conf         = conf
geniac       = geniac
dependencies = recipes.dependencies
conda        = recipes.conda
singularity  = recipes.singularity
docker       = recipes.docker
env          = env
modules      = modules.fromSource

# Nextflow configuration default files analyzed by the linter
[geniac.lint.expected.config]
nextflow     = ${tree.base:path}/nextflow.config
base         = ${tree.conf:path}/base.config
process      = ${tree.conf:path}/process.config
geniac       = ${tree.conf:path}/geniac.config
genomes      = ${tree.conf:path}/genomes.config
test         = ${tree.conf:path}/test.config
all          = ${tree.conf:path}/**/*.config

# Files generated by geniac. They are normally included in Nextflow profiles
[geniac.lint.generated.config]
conda        = ${tree.conf:path}/conda.config
multiconda   = ${tree.conf:path}/multiconda.config
singularity  = ${tree.conf:path}/singularity.config
docker       = ${tree.conf:path}/docker.config
path         = ${tree.conf:path}/path.config
multipath    = ${tree.conf:path}/multipath.config
cluster      = ${tree.conf:path}/cluster.config

# Geniac lint global parameters
[geniac.lint]
# Toggle ON/OFF check of conda packages with conda CLI
condaCheck   =   false

###############################################################################
#                       Geniac install options                                #
###############################################################################

# geniac install global parameters
[geniac.install]
mode
cmakeOutputPattern  = ^(?P<option_name>ap_\w+):(?P<option_type>\w+)=(?P<option_value>\w*)$$
cmakeSudoOptions    =
    -Dap_install_singularity_images=ON
    -Dap_install_docker_images=ON
    -Dap_install_podman_images=ON

cmakeFakeRootOptions    =
    -Dap_singularity_build_options="-f"
    -Dap_singularity_build_options='-f'
    -Dap_singularity_build_options="--fakeroot"
    -Dap_singularity_build_options='--fakeroot'

[geniac.install.modes]
all                 =
    -Dap_install_singularity_images=ON
    -Dap_install_singularity_recipes=ON
    -Dap_install_docker_images=ON
    -Dap_install_docker_recipes=ON
docker              =
    -Dap_install_docker_images=ON
    -Dap_install_docker_recipes=OFF
podman              =
    -Dap_install_podman_images=ON
    -Dap_install_podman_recipes=OFF
singularity         =
    -Dap_install_singularity_images=ON
    -Dap_install_singularity_recipes=OFF
singularityfakeroot         =
    -Dap_install_singularity_images=ON
    -Dap_install_singularity_recipes=OFF
    -Dap_singularity_build_options='--fakeroot'

###############################################################################
#    Tree section describe the content of a template compatible with geniac   #
###############################################################################

# Root folder
[tree.base]
# Is the folder required ?
required    = true
# Is the folder recommended ?
recommended = true
# Should we analyze files and sub directories recursively  or only the root ?
recursive   = true
# Path to the folder
path        = .
# Path(s) to mandatory file(s)
mandatory   =
    ${project.workflow:main}
    ${geniac.lint.expected.config:nextflow}
# Path(s) to optional file(s)
optional
# Path(s) to file(s) excluded from the analysis
excluded    =
    ${tree.base:path}/geniac/**/*.nf
# Path(s) to file(s) not allowed in the path
prohibited

[tree.geniac]
required    = true
recommended = true
recursive   = false
path        = ${tree.base:path}/geniac
mandatory
optional
excluded     =
    ${tree.geniac:path}/**/*.nf
prohibited

# base/conf
[tree.conf]
required    = true
recommended = true
recursive   = false
path        = ${tree.base:path}/conf
mandatory   =
    ${geniac.lint.expected.config:base}
    ${geniac.lint.expected.config:geniac}
    ${geniac.lint.expected.config:process}
optional   =
    ${geniac.lint.expected.config:test}
    ${geniac.lint.expected.config:genomes}
excluded    =
    ${tree.conf:path}/*.md
    ${tree.conf:path}/*.rst
    ${tree.conf:path}/*.txt
    ${geniac.lint.generated.config:conda}
    ${geniac.lint.generated.config:multiconda}
    ${geniac.lint.generated.config:singularity}
    ${geniac.lint.generated.config:docker}
    ${geniac.lint.generated.config:path}
    ${geniac.lint.generated.config:multipath}
    ${geniac.lint.generated.config:cluster}
prohibited

# base/recipes
[tree.recipes]
required    = false
recommended = false
recursive   = false
path        = ${tree.base:path}/recipes
mandatory
optional
excluded    =
    ${tree.recipes:path}/*.md
    ${tree.recipes:path}/*.rst
    ${tree.recipes:path}/*.txt
prohibited

# base/recipes/conda
[tree.recipes.conda]
required    = false
recommended = false
recursive   = false
path        = ${tree.recipes:path}/conda
mandatory   =
    ${tree.recipes.conda:path}/*.yml
    ${tree.recipes.conda:path}/*.yaml
optional
excluded     =
    ${tree.recipes.conda:path}/*.md
    ${tree.recipes.conda:path}/*.rst
    ${tree.recipes.conda:path}/*.txt
prohibited

# base/recipes/singularity
[tree.recipes.singularity]
required    = false
recommended = false
recursive   = false
path        = ${tree.recipes:path}/singularity
mandatory   =
    ${tree.recipes.singularity:path}/*.def
optional
excluded     =
    ${tree.recipes.singularity:path}/*.md
    ${tree.recipes.singularity:path}/*.rst
    ${tree.recipes.singularity:path}/*.txt
prohibited

# base/recipes/docker
[tree.recipes.docker]
required    = false
recommended = false
recursive   = false
path        = ${tree.recipes:path}/docker
mandatory   =
    ${tree.recipes.docker:path}/*.DockerFiles
optional
excluded     =
    ${tree.recipes.docker:path}/*.md
    ${tree.recipes.docker:path}/*.rst
    ${tree.recipes.docker:path}/*.txt
prohibited

# base/recipes/dependencies
[tree.recipes.dependencies]
required    = false
recommended = false
recursive   = true
path        = ${tree.recipes:path}/dependencies
mandatory
optional
excluded     =
    ${tree.recipes.dependencies:path}/*.md
    ${tree.recipes.dependencies:path}/*.rst
    ${tree.recipes.dependencies:path}/*.txt
prohibited

# base/modules
[tree.modules]
required    = false
recommended = true
recursive   = false
path        = ${tree.base:path}/modules
mandatory
optional
excluded
prohibited    =
    ${tree.modules:path}/CMakeLists.txt

# base/modules
[tree.modules.fromSource]
required    = false
recommended = true
recursive   = true
path        = ${tree.modules:path}/fromSource
mandatory   =
    ${tree.modules.fromSource:path}/CMakeLists.txt
    ${tree.modules.fromSource:path}/*/CMakeLists.txt
optional
excluded
prohibited

# base/env
[tree.env]
required    = false
recommended = true
recursive   = false
path        = ${tree.base:path}/env
mandatory
optional
excluded
prohibited

# base/test
[tree.test]
required    = false
recommended = true
recursive   = false
path        = ${tree.base:path}/test
mandatory
optional
excluded
prohibited

# base/test/data
[tree.test.data]
required    = false
recommended = true
recursive   = false
path        = ${tree.test:path}/data
mandatory
optional
excluded
prohibited

###############################################################################
#  Scope section describe which Nextflow config scopes is required for geniac #
###############################################################################
# Each section is defined with the following attributes
# [scope.sectionName]                   -> Define a new Nextflow config scope
# files                                 -> config files where this scope is found (all by default)
# required (bool)                       -> Is this scope mandatory for geniac ?
# paths (list)                          -> list of Nextflow parameters in this scope which should be
#                                       interpreted as paths
# properties (list)                     -> list of mandatory Nextflow parameters in this scope
# patterns (list)                       -> list of regex related to the expected format of the
#                                       parameters in this scope
# scopes (list)                         -> list of nested scopes
# [scope.sectionName.values.default]                   -> Define a new Nextflow config scope
# TODO

# env
[scope.env]
files
required    = false
paths
properties
patterns
scopes

# params
[scope.params]
files
required    = true
paths       =
    genomeAnnotationPath
properties
patterns
scopes      =
    geniac

[scope.params.values.default]
files                   =
    ${geniac.lint.expected.config:base}
    ${geniac.lint.expected.config:geniac}
genomeAnnotationPath    =
    $${projectDir}/../annotations
    ""
    ''

# params.geniac
[scope.params.geniac]
files
required    = true
paths       =
    singularityImagePath
    multiPath
    path
properties
patterns
scopes      =
    tools
    containers

[scope.params.geniac.values.default]
singularityImagePath    = $${projectDir}/../containers/singularity
multiPath               = $${projectDir}/../multipath
path                    = $${projectDir}/../path/bin

# params.geniac.tools
[scope.params.geniac.tools]
files
required    = false
paths
properties
patterns
scopes

# params.geniac.containers
[scope.params.geniac.containers]
files
required    = false
paths
properties  =
    singularityRunOptions
    dockerRunOptions
patterns
scopes      =
    yum
    git
    cmd

[scope.params.geniac.containers.values.default]
singularityRunOptions   = "--bind $${params.containers.specificBinds}"
dockerRunOptions        = ""
podmanRunOptions        = ""

[scope.params.geniac.containers.values.prohibited]
singularityRunOptions   = (?P<opt>(?<=-B )|(?<=--bind ))\s*(?P<values>[\w_/,:]*(?P<prohibited>((?P<precomma>,)|(?<= ))(?P<host>[\w/_]+:|)(?P<prohibited_pattern>/tmp)(?P<mnt>:[\w/_]+|)((?(precomma)|,)|\s|$$))[\w_/,:]*)

# params.geniac.containers.yum
[scope.params.geniac.containers.yum]
files
required    = false
paths
properties
patterns
scopes

# params.geniac.containers.git
[scope.params.geniac.containers.git]
files
required    = false
paths
properties
patterns
scopes

# params.geniac.containers.cmd
[scope.params.geniac.containers.cmd]
files
required    = false
paths
properties
patterns
scopes      =
    post
    envCustom

# params.geniac.containers.cmd.post
[scope.params.geniac.containers.cmd.post]
files
required    = false
paths
properties
patterns     = (?P<list>\[(?P<listElt>(?P<command>(?P<quote>(?P<simpleQuote>')|(?P<doubleQuote>\"))(?(simpleQuote)[\"\\!\w\s]*|)(?(doubleQuote)['\\!\w\s]*|)(?P=quote))(?P<closeElt>(\s*,\s*|\])))+(?<=\]))|(?P<emptyList>\[\s*\])
scopes

# params.geniac.containers.cmd.envCustom
[scope.params.geniac.containers.cmd.envCustom]
files
required    = false
paths
properties
patterns    = (?P<list>\[(?P<listElt>(?P<command>(?P<quote>(?P<simpleQuote>')|(?P<doubleQuote>\"))(?(simpleQuote)[A-Z0-9_]+=[\"\\!\w\s]*|)(?(doubleQuote)[A-Z0-9_]+=['\\!\w\s]*|)(?P=quote))(?P<closeElt>(\s*,\s*|\])))+(?<=\]))|(?P<emptyList>\[\s*\])
scopes

# process
[scope.process]
files
required    = false
paths
properties  =
    accelerator
    afterScript
    beforeScript
    cache
    cpus
    conda
    container
    containerOptions
    clusterOptions
    disk
    echo
    errorStrategy
    executor
    ext
    label
    machineType
    maxErrors
    maxForks
    maxRetries
    memory
    module
    penv
    pod
    publishDir
    queue
    scratch
    stageInMode
    stageOutMode
    storeDir
    tag
    time
    validExitStatus
patterns
scopes

# executor
[scope.executor]
files
required    = false
paths
properties  =
    name
    queueSize
    pollInterval
    dumpInterval
    queueStatInterval
    exitReadTimeout
    killBatchSize
    submitRateLimit
    perJobMemLimit
    jobName
    cpus
    memory
patterns
scopes

# docker
[scope.docker]
files
required    = false
paths
properties  =
    enabled
    envWhitelist
    legacy
    sudo
    tty
    temp
    remove
    runOptions
    registry
    fixOwnership
    engineOptions
    mountFlags
patterns
scopes

# singularity
[scope.singularity]
files
required    = false
paths
properties  =
    enabled
    engineOptions
    envWhitelist
    runOptions
    noHttps
    autoMounts
    cacheDir
    pullTimeout
patterns
scopes

# podman
[scope.podman]
files
required    = false
paths
properties  =
    enabled
    envWhitelist
    temp
    remove
    runOptions
    registry
    engineOptions
    mountFlags
patterns
scopes

# manifest
[scope.manifest]
files
required    = false
paths
properties  =
    author
    defaultBranch
    recurseSubmodules
    description
    doi
    homePage
    mainScript
    name
    nextflowVersion
    version
patterns
scopes

# trace
[scope.trace]
files
required    = false
paths
properties  =
    enabled
    fields
    file
    sep
    raw
patterns
scopes

# aws
[scope.aws]
files
required    = false
paths
properties  =
    accessKey
    secretKey
    region
patterns
scopes      =
    client
    batch

# aws.client
[scope.aws.client]
files
required    = false
paths
properties  =
    connectionTimeout
    endpoint
    maxConnections
    maxErrorRetry
    protocol
    proxyHost
    proxyPort
    proxyUsername
    proxyPassword
    signerOverride
    socketSendBufferSizeHint
    socketRecvBufferSizeHint
    socketTimeout
    storageEncryption
    userAgent
    uploadMaxThreads
    uploadChunkSize
    uploadStorageClass
    uploadMaxAttempts
    uploadRetrySleep
patterns
scopes

# aws.batch
[scope.aws.batch]
files
required    = false
paths
properties  =
    cliPath
    jobRole
    volumes
    delayBetweenAttempts
    maxParallelTransfers
    maxTransferAttempts
patterns
scopes

# conda
[scope.conda]
files
required    = false
paths
properties  =
    cacheDir
    createTimeout
patterns
scopes

# k8s
[scope.k8s]
files
required    = false
paths
properties  =
    autoMountHostPaths
    context
    namespace
    serviceAccount
    launchDir
    workDir
    projectDir
    pod
    pullPolicy
    runAsUser
    storageClaimName
    storageMountPath
    storageSubPath
    volumeClaims
patterns
scopes

# timeline
[scope.timeline]
files
required    = false
paths
properties  =
    enabled
    file
patterns
scopes

# mail
[scope.mail]
files
required    = false
paths
properties  =
    from
    debug
    smtp.host
    smtp.port
    smtp.user
    smtp.password
    smtp.connectiontimeout
    smtp.timeout
    smtp.writetimeout
    smtp.from
    smtp.localhost
    smtp.localaddress
    smtp.localport
    smtp.ehlo
    smtp.auth
    smtp.auth.mechanisms
    smtp.auth.login.disable
    smtp.auth.plain.disable
    smtp.auth.digest-md5.disable
    smtp.auth.ntlm.disable
    smtp.auth.ntlm.domain
    smtp.auth.ntlm.flags
    smtp.auth.xoauth2.disable
    smtp.submitter
    smtp.dsn.notify
    smtp.dsn.ret
    smtp.allow8bitmime
    smtp.sendpartial
    smtp.sasl.enable
    smtp.sasl.mechanisms
    smtp.sasl.authorizationid
    smtp.sasl.realm
    smtp.sasl.usecanonicalhostname
    smtp.quitwait
    smtp.reportsuccess
    smtp.socketFactory
    smtp.socketFactory.class
    smtp.socketFactory.fallback
    smtp.socketFactory.port
    smtp.ssl.enable
    smtp.ssl.checkserveridentity
    smtp.ssl.trust
    smtp.ssl.socketFactory
    smtp.ssl.socketFactory.class
    smtp.ssl.socketFactory.port
    smtp.ssl.protocols
    smtp.ssl.ciphersuites
    smtp.starttls.enable
    smtp.starttls.required
    smtp.proxy.host
    smtp.proxy.port
    smtp.proxy.user
    smtp.proxy.password
    smtp.socks.host
    smtp.socks.port
    smtp.mailextension
    smtp.userset
    smtp.noop.strict
patterns
scopes

# notification
[scope.notification]
files
required    = false
paths
properties  =
    enabled
    to
    from
    template
    binding
patterns
scopes

# report
[scope.report]
files
required    = false
paths
properties  =
    enabled
    file
patterns
scopes

# weblog
[scope.weblog]
files
required    = false
paths
properties  =
    enabled
    url
patterns
scopes
